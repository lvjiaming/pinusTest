"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * The main class and interface of the schedule module
 */
const PriorityQueue = require("./priorityQueue");
const Job = require("./job");
const pinus_logger_1 = require("pinus-logger");
const path = require("path");
let logger = pinus_logger_1.getLogger('pinus-scheduler', path.basename(__filename));
let timerCount = 0;
let map = {};
let queue = PriorityQueue.createPriorityQueue(comparator);
let jobId = 0;
let timer;
// The accuracy of the scheduler, it will affect the performance when the schedule tasks are
// crowded together
let accuracy = 10;
/**
 * Schedule a new Job
 * @param trigger The trigger to use
 * @param jobFunc The function the job to run
 * @param jobData The data the job use
 * @return The job id, which can be canceled by cancelJob(id:number)
 */
function scheduleJob(trigger, jobFunc, jobData) {
    let job = Job.createJob(trigger, jobFunc, jobData);
    let excuteTime = job.excuteTime();
    let id = job.id;
    map[id] = job;
    let element = {
        id: id,
        time: excuteTime
    };
    let curJob = queue.peek();
    if (!curJob || excuteTime < curJob.time) {
        queue.offer(element);
        setTimer(job);
        return job.id;
    }
    queue.offer(element);
    return job.id;
}
exports.scheduleJob = scheduleJob;
/**
 * Cancel Job
 */
function cancelJob(id) {
    let curJob = queue.peek();
    if (curJob && id === curJob.id) { // to avoid queue.peek() is null
        queue.pop();
        delete map[id];
        clearTimeout(timer);
        excuteJob();
    }
    delete map[id];
    return true;
}
exports.cancelJob = cancelJob;
/**
 * Clear last timeout and schedule the next job, it will automaticly run the job that
 * need to run now
 * @param job The job need to schedule
 * @return void
 */
function setTimer(job) {
    clearTimeout(timer);
    timer = setTimeout(excuteJob, job.excuteTime() - Date.now());
}
/**
 * The function used to ran the schedule job, and setTimeout for next running job
 */
function excuteJob() {
    let job = peekNextJob();
    let nextJob;
    while (!!job && (job.excuteTime() - Date.now()) < accuracy) {
        job.run();
        queue.pop();
        let nextTime = job.nextTime();
        if (nextTime === null) {
            delete map[job.id];
        }
        else {
            queue.offer({ id: job.id, time: nextTime });
        }
        job = peekNextJob();
    }
    // If all the job have been canceled
    if (!job)
        return;
    // Run next schedule
    setTimer(job);
}
/**
 * Return, but not remove the next valid job
 * @return Next valid job
 */
function peekNextJob() {
    if (queue.size() <= 0)
        return null;
    let job = null;
    do {
        job = map[queue.peek().id];
        if (!job)
            queue.pop();
    } while (!job && queue.size() > 0);
    return (!!job) ? job : null;
}
/**
 * Return and remove the next valid job
 * @return Next valid job
 */
function getNextJob() {
    let job = null;
    while (!job && queue.size() > 0) {
        let id = queue.pop().id;
        job = map[id];
    }
    return (!!job) ? job : null;
}
function comparator(e1, e2) {
    return e1.time > e2.time;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NoZWR1bGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9saWIvc2NoZWR1bGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQTs7R0FFRztBQUNILGlEQUFpRDtBQUNqRCw2QkFBNkI7QUFJN0IsK0NBQXlDO0FBQ3pDLDZCQUE2QjtBQUM3QixJQUFJLE1BQU0sR0FBRyx3QkFBUyxDQUFDLGlCQUFpQixFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztBQUVyRSxJQUFJLFVBQVUsR0FBRyxDQUFDLENBQUM7QUFDbkIsSUFBSSxHQUFHLEdBQTZCLEVBQUUsQ0FBQztBQUN2QyxJQUFJLEtBQUssR0FBRyxhQUFhLENBQUMsbUJBQW1CLENBQUMsVUFBVSxDQUFDLENBQUM7QUFFMUQsSUFBSSxLQUFLLEdBQUcsQ0FBQyxDQUFDO0FBQ2QsSUFBSSxLQUFVLENBQUM7QUFFZiw0RkFBNEY7QUFDNUYsbUJBQW1CO0FBQ25CLElBQUksUUFBUSxHQUFHLEVBQUUsQ0FBQztBQUVsQjs7Ozs7O0dBTUc7QUFDSCxTQUFTLFdBQVcsQ0FBSSxPQUFtQyxFQUFFLE9BQTJCLEVBQUUsT0FBVztJQUNqRyxJQUFJLEdBQUcsR0FBWSxHQUFHLENBQUMsU0FBUyxDQUFDLE9BQU8sRUFBRSxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDNUQsSUFBSSxVQUFVLEdBQUcsR0FBRyxDQUFDLFVBQVUsRUFBRSxDQUFDO0lBQ2xDLElBQUksRUFBRSxHQUFHLEdBQUcsQ0FBQyxFQUFFLENBQUM7SUFFaEIsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEdBQUcsQ0FBQztJQUNkLElBQUksT0FBTyxHQUFHO1FBQ1YsRUFBRSxFQUFFLEVBQUU7UUFDTixJQUFJLEVBQUUsVUFBVTtLQUNuQixDQUFDO0lBRUYsSUFBSSxNQUFNLEdBQUcsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDO0lBQzFCLElBQUksQ0FBQyxNQUFNLElBQUksVUFBVSxHQUFH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